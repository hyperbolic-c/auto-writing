# 分章节全文获取与写作设计

> **Goal:** 实现分章节全文获取流程，支持需求文档的章节结构化解析，按章节获取参考文献全文，语义匹配后仿写内容

## 背景

v2.1.0 原有设计按文献类型（精确匹配/语义匹配）区分全文获取，但存在以下问题：
- LLM 可绕过 `zotero_get_item_fulltext` 直接调用 `zotero_get_item_metadata` 获取摘要
- 章节内容与文献内容无法直接对齐（文献标题通常不含明确主题信息）

## 新设计

### 核心思路

**分章节处理**：按需求文档的章节结构逐个处理，每个章节独立获取参考文献全文并进行写作。

---

## 需求文档格式

### 格式1：固定模板（结构化）

```markdown
论文题目：p-MQWs-n型AlGaN日盲紫外探测器研究

# 第1章 绪论
## 1.1 研究背景与意义
- 日盲紫外探测在军事和民用领域的重要应用
- 现有技术的局限性

### 参考文献
- "Recent progress in AlGaN-based UV photodetectors"
- "Review of visible-blind and solar-blind UV detectors"

# 第2章 p-MQWs-n型AlGaN日盲紫外探测器研究
## 2.1 引言
- 日盲紫外探测器的重要性
- 研究进展与存在的问题

### 参考文献
- "High-efficiency AlGaN photodetector with multi-quantum wells"

## 2.2 器件设计与制备
- p-MQWs-n结构的设计原理
- AlGaN外延片的外延生长
- 光刻与蒸镀电极工艺

### 参考文献
- "MQWs structure design for UV photodetectors"

## 2.3 本章小结

# 第3章 实验结果与讨论
## 3.1 器件结构表征
- SEM测试结果
- XRD晶体质量分析

### 参考文献
- ...

## 3.2 本章小结
```

### 格式2：自由格式（行内标注）

```markdown
论文题目：AlGaN日盲紫外探测器研究

# 第2章 器件研究
## 2.1 引言
日盲紫外探测器在导弹尾焰探测中具有重要应用。参考文献：ZnO基日盲紫外探测器研究进展。当前技术面临的主要挑战包括噪声控制和响应速度问题。
- 材料生长工艺复杂
- 器件稳定性有待提高

## 2.2 器件制备与测试
AlGaN外延片的设计与生长是器件性能的关键。参考文献：High-quality AlGaN growth techniques。蒸镀电极工艺需要优化接触特性。
```

### 参考文献识别规则

| 格式 | 识别方式 | 示例 |
|------|----------|------|
| 模板格式 | `### 参考文献` + `- "标题"` | `### 参考文献\n- "Title1"` |
| 行内格式 | `参考文献：...。` 或 `参考文献：...` | `参考文献：ZnO日盲探测器研究进展。` |

---

## 处理流程

```
需求文档
    ↓
解析章节结构（一级标题 → 二级标题 → 内容要点）
    ↓
遍历每个章节：
    ├── 提取该章节的参考文献标题列表
    ├── 调用 zotero_get_item_fulltext 获取全文
    ├── 分析文献内容（按段落拆分，忽略标题）
    ├── 语义匹配：内容要点 → 文献段落
    ├── 以第一篇为主要模板，匹配段落仿写
    └── 写作时引用语义搜索文献作为补充论证
    ↓
输出完整章节内容
```

---

## 规则总结

| 规则 | 说明 |
|------|------|
| 参考文献范围 | 每章节只使用明确标注的参考文献 |
| 多文献处理 | 全部获取，以**第一篇**为主要模板 |
| 匹配方式 | 语义匹配内容要点与文献段落（忽略文献标题） |
| 仿写粒度 | 按语义相关段落仿写，非章节编号对齐 |
| 论点支撑 | 可引用语义搜索文献作为补充论证 |

---

## 输入输出示例

### 输入

```markdown
论文题目：p-MQWs-n型AlGaN日盲紫外探测器研究

# 第2章 p-MQWs-n型AlGaN日盲紫外探测器研究
## 2.1 引言
- 日盲紫外探测器的重要性
- 研究进展与存在的问题

### 参考文献
- "High-performance AlGaN UV detector"
- "ZnO-based photodetector for solar-blind application"

## 2.2 器件设计与制备
- p-MQWs-n结构的设计原理
- AlGaN外延片的外延生长
- 光刻与蒸镀电极工艺

### 参考文献
- "MQWs structure design for UV photodetectors"
```

### 处理过程

```
章节: 2.1 引言
参考文献: ["High-performance AlGaN UV detector", "ZnO-based photodetector..."]
  ├─ 获取全文: High-performance AlGaN UV detector ✓
  ├─ 获取全文: ZnO-based photodetector... ✓
  ├─ 分析文献内容（按段落拆分）
  ├─ 语义匹配:
  │   - "日盲紫外探测器的重要性" → 文献 Introduction 段落
  │   - "研究进展与存在的问题" → 文献 Related Work 段落
  └─ 仿写 → 生成 2.1 内容

章节: 2.2 器件设计与制备
参考文献: ["MQWs structure design..."]
  ├─ 获取全文: MQWs structure design... ✓
  ├─ 分析文献内容（按段落拆分）
  ├─ 语义匹配:
  │   - "p-MQWs-n结构设计原理" → Device Structure 段落
  │   - "AlGaN外延片生长" → Epitaxial growth 段落
  │   - "光刻、蒸镀电极" → Fabrication process 段落
  └─ 仿写 → 生成 2.2 内容
```

### 输出

```markdown
## 2.1 引言

日盲紫外探测器（波长200-280 nm）在导弹尾焰探测、臭氧层监测等领域具有重要应用价值[1]。相比于可见光和红外探测器，日盲紫外探测器具有背景噪声低、定位精度高、抗干扰能力强等优势[1]。

然而，传统日盲紫外探测器面临以下挑战：
- ...

## 2.2 器件设计与制备

本文设计了一种p-MQWs-n（p型层-多量子阱-n型层）结构的AlGaN日盲紫外探测器。该结构利用多量子阱有源区增强光电转换效率，同时通过p型和n型掺杂实现载流子的有效注入[1]。

AlGaN外延片采用金属有机化学气相沉积（MOCVD）技术在蓝宝石衬底上生长[1]。生长过程中需要严格控制温度、压强和源流量，以获得高质量的晶体结构和光电特性[1]。

器件制备采用标准的光刻工艺定义电极图案，然后通过电子束蒸镀在器件表面沉积Cr/Au电极[2]。蒸镀完成后进行快速热退火处理以形成良好的欧姆接触[2]。
```

---

## 实现任务

### 任务1: 更新 reference-manager SKILL.md

- 新增输入格式：支持解析需求文档
- 新增处理步骤：章节识别、参考文献提取、全文获取
- 新增输出格式：按章节返回全文内容

### 任务2: 更新 paper-writer SKILL.md

- 新增输入格式：章节内容要点 + 参考文献全文
- 新增处理步骤：语义匹配段落 → 仿写
- 明确规则：第一篇文献为主要模板

### 任务3: 创建需求文档模板

- 提供结构化模板供用户填写
- 支持两种格式（固定模板/自由格式）

---

## 文件清单

| 文件 | 修改类型 |
|------|----------|
| `skills/reference-manager/SKILL.md` | 修改 |
| `skills/paper-writer/SKILL.md` | 修改 |
| `docs/plans/YYYY-MM-DD-section-based-fulltext-retrieval-design.md` | 新建（本文档） |

---

## 验证步骤

1. 输入需求文档，验证章节解析正确
2. 验证每章节的参考文献被正确提取
3. 验证 `zotero_get_item_fulltext` 被调用获取全文
4. 验证输出内容与文献段落语义匹配
5. 验证仿写内容覆盖所有内容要点
